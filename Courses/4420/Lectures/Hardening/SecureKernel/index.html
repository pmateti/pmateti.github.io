<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-10-13 Sun 12:59 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hardening A Linux Kernel</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Prabhaker Mateti" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<style> P,li {text-align: justify} code {color: brown;} @media screen {BODY {margin: 10%} }</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="../"> UP </a>
 |
 <a accesskey="H" href="../../Top/index.html"> HOME </a>
</div><div id="preamble" class="status">
<a href="../../"> ../../</a> | <a href=./>NoSlides</a>
</div>
<div id="content">
<h1 class="title">Hardening A Linux Kernel</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org47997b8">1. Overview</a>
<ul>
<li><a href="#orgf402f4d">1.1. Add/ Delete/ Freeze System Calls</a></li>
<li><a href="#orgd8699dd">1.2. Awareness of Linux Kernel Exploits</a></li>
<li><a href="#org4dc6357">1.3. Hardening of System Programs</a></li>
<li><a href="#orgffcff41">1.4. Scope of Kernel Hardening in this Course</a></li>
</ul>
</li>
<li><a href="#orgffc3010">2. Hardening Ideas</a>
<ul>
<li><a href="#org41dea2f">2.1. Careful Recompilation</a></li>
<li><a href="#orgfbdd687">2.2. Least Privilege</a></li>
<li><a href="#orgd7c90f0">2.3. Capabilities</a></li>
<li><a href="#org07e1813">2.4. Mandatory Access Control</a></li>
<li><a href="#org3288255">2.5. Role-Based Access Control</a></li>
<li><a href="#org52a381b">2.6. Source Code Review</a></li>
<li><a href="#org39e500d">2.7. Check Thyself</a></li>
<li><a href="#org9a2b619">2.8. Mutual authentication: init v kernel</a></li>
<li><a href="#org6bcd7c5">2.9. Scope of ptrace(2)</a></li>
<li><a href="#orgaa218ab">2.10. Trusted OS Loader</a></li>
</ul>
</li>
<li><a href="#org8886275">3. Security Enhancements in the Linux Kernel</a>
<ul>
<li><a href="#org4be72ed">3.1. POSIX capabilities</a></li>
<li><a href="#org3edc577">3.2. Linux Namespaces</a></li>
<li><a href="#org0d3f3a2">3.3. Hardening the System Calls</a></li>
<li><a href="#org37e6181">3.4. Seccomp (Secure Computing Mode)</a></li>
<li><a href="#org0ccfe5c">3.5. Control Groups (cgroups)</a></li>
<li><a href="#org92f5bc7">3.6. Linux Security Modules (LSM)</a></li>
<li><a href="#org8d2e399">3.7. Chroot Restrictions</a></li>
<li><a href="#org117fba3">3.8. Grsecurity</a></li>
<li><a href="#orgc1e6b02">3.9. PaX Address Space Protection</a></li>
<li><a href="#orgda493eb">3.10. Buffer Overflow Attack Prevention</a></li>
<li><a href="#org70b821e">3.11. Linux Security Modules (LSM)</a></li>
<li><a href="#orgeae39b8">3.12. Secure Linux containers</a></li>
<li><a href="#org22e79d6">3.13. Linux Memory Forensics</a></li>
<li><a href="#org2f9bf56">3.14. Intrusion Detection/ Prevention</a></li>
</ul>
</li>
<li><a href="#org212274a">4. Kernel Security Modules</a></li>
<li><a href="#orgae235aa">5. References</a></li>
<li><a href="#org5a31292">6. End</a></li>
</ul>
</div>
</div>

<div id="outline-container-org47997b8" class="outline-2">
<h2 id="org47997b8"><span class="section-number-2">1</span> Overview</h2>
<div class="outline-text-2" id="text-1">
<ol class="org-ol">
<li>This article is about <b>hardening</b> a Linux kernel. Includes applying
patches to fix kernel bugs, and design + implementation
improvements.</li>

<li>Hardening a system == Harden the kernel + Harden Sys Programs</li>

<li>Related: Build a Kernel (as-is or after hardening)</li>

<li>We distinguish hardening a system from proper configuration and
fortification.  In this lecture, we describe areas of tightening
security during the design and construction of systems rather than
after their deployment.  This distinction is not common yet.  There
exist several "hardening" scripts, e.g., Bastille, that just help
do proper configuration.</li>

<li>There are "secure operating systems" and "trusted operating
systems." Alas, no one can offer technically rigorous definitions
for these terms.  Windows NT, and several of Unix derivatives
claimed, over the years, to be secure and trusted.  For example, we
found the following quote, early 2000s, "Windows NT is a secure
operating system but only if it's configured correctly."
Nevertheless, operating systems that lay claim to either being
secure or trusted are better designed and engineered from their
inception with a concern for security.</li>
</ol>
</div>


<div id="outline-container-orgf402f4d" class="outline-3">
<h3 id="orgf402f4d"><span class="section-number-3">1.1</span> Add/ Delete/ Freeze System Calls</h3>
<div class="outline-text-3" id="text-1-1">
<ol class="org-ol">
<li>It is not difficult to add system calls to the kernel.</li>
<li>Using the Linux Kernel Modules mechanisms, Add/ Delete/ Freeze
System Calls can be done while the kernel is running.</li>
<li>TBD Link Lecture The Lab Lx TBD link gives you practical experience
of doing this.</li>
</ol>
</div>
</div>

<div id="outline-container-orgd8699dd" class="outline-3">
<h3 id="orgd8699dd"><span class="section-number-3">1.2</span> Awareness of Linux Kernel Exploits</h3>
<div class="outline-text-3" id="text-1-2">
<ol class="org-ol">
<li>Lecture on <a href="../../KernelExploits/">../../KernelExploits/</a>
<ol class="org-ol">
<li>BackDoors</li>
<li>SymLinkAttack</li>
<li>RaceConditions</li>
<li>Viruses</li>
<li>privilege-escalation.org</li>
<li>RootKits</li>
</ol></li>
</ol>
</div>
</div>

<div id="outline-container-org4dc6357" class="outline-3">
<h3 id="org4dc6357"><span class="section-number-3">1.3</span> Hardening of System Programs</h3>
<div class="outline-text-3" id="text-1-3">
<ol class="org-ol">
<li>[List is not exhaustive; traditional, not minimalistic, view.]</li>
<li>all of <code>/sbin</code>, <code>/usr/sbin</code> (can be pruned heavily)</li>
<li>all suid root programs.  Recall the find-based script.</li>
</ol>
</div>
</div>

<div id="outline-container-orgffcff41" class="outline-3">
<h3 id="orgffcff41"><span class="section-number-3">1.4</span> Scope of Kernel Hardening in this Course</h3>
<div class="outline-text-3" id="text-1-4">
<ol class="org-ol">
<li>We should be able to apply the tools of Development of Software
without Security Holes.</li>

<li>We should be able to gather the patches delivered by experts since
the last such harvest.</li>

<li>We should be able to patch the publicly released kernel, and build
a new hardened kernel.  We select the patches from the above
harvest.  We may omit some.  The reasons for both select/ omit are
documented.</li>

<li>We are not expecting to discover new bugs that are worthy of being
flashed across the world tech news sites.</li>

<li>Limited by the time and lectures we can devote to this topic.</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orgffc3010" class="outline-2">
<h2 id="orgffc3010"><span class="section-number-2">2</span> Hardening Ideas</h2>
<div class="outline-text-2" id="text-2">
<p>
The space of hardening a system is vast.  It includes new ideas yet to
be implemented in widely used OS (e.g., Windows, and Linux).  It
includes re-designing and re-implementing existing ideas such as
"change-roots".  It includes analyzing the source code of an OS
extremely carefully by experts as well as via software tools based on
mathematical proof techniques.  The next few sections introduce these
ideas further.
</p>
</div>

<div id="outline-container-org41dea2f" class="outline-3">
<h3 id="org41dea2f"><span class="section-number-3">2.1</span> Careful Recompilation</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Stack smashing (buffer overflow) attacks are among the most common.  By
and large, these are programming errors that can be caught by
analytical techniques.  Newer compilers are mechanizing these
techniques.  See the Buffer Overflow Attacks and Development of Software
without Secure Holes  articles.
</p>
</div>
</div>

<div id="outline-container-orgfbdd687" class="outline-3">
<h3 id="orgfbdd687"><span class="section-number-3">2.2</span> Least Privilege</h3>
<div class="outline-text-3" id="text-2-2">
<p>
On Linux systems, the user called root or super user, with user-id 0,
can bypass (nearly) all security restrictions.  Windows systems have
the "System" and "Administrator" accounts.  The super user privilege
should be split into many smaller privileges.  E.g., a backup process
should be able to read any file, but it should not be able to shut
down the system, modify files, or send network packets.  Processes, not
users, should be given privileges.  The backup process should be
permitted to read all files, even though the root user who invokes the
program should not be allowed such access.  The backup process should
not be able to pass its privileges down to processes that it
starts.  The use of such finely divided abilities instead of sweeping
powerful mechanisms is called the <i>least privilege</i> principle.
</p>

<p>
The traditional Unix model allows for access control of only
files.  So, a number of resources become "files": processes, hard
disks, network interfaces, etc.  In order to apply the principle of
least privilege, we also need to divide the resources into finer units
(often called objects, but unrelated to OOP).  The users and processes
are called subjects.
</p>
</div>
</div>

<div id="outline-container-orgd7c90f0" class="outline-3">
<h3 id="orgd7c90f0"><span class="section-number-3">2.3</span> Capabilities</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Capabilities is a word used with different meanings in the context of
OS design.  In OS research literature, processes hold tokens, called
capabilities, denoting resources to be accessed and what can be done
with them.  Capabilities can be explicitly passed among
processes.  Linux, and Windows are not capability based in this
sense.  This usage of the word is unrelated to "POSIX capabilities"
which are implemented in Linux and described later.
</p>
</div>
</div>

<div id="outline-container-org07e1813" class="outline-3">
<h3 id="org07e1813"><span class="section-number-3">2.4</span> Mandatory Access Control</h3>
<div class="outline-text-3" id="text-2-4">
<p>
An OS can control access by attaching <i>sensitivity labels</i> (SLs) to
objects (files, processes, network interfaces, packets, and so on).
E.g., incoming network packets can be assigned SLs, based on the
source IP address or the network interface.  Outgoing packets can have
the label of the process that created them.  A filtering rule can then
be formulated so that packets can be dropped if the SL does not
satisfy some conditions.  When inheritance of privileges is not
assumed, this is known as <i>mandatory access control</i>.
</p>
</div>
</div>

<div id="outline-container-org3288255" class="outline-3">
<h3 id="org3288255"><span class="section-number-3">2.5</span> Role-Based Access Control</h3>
<div class="outline-text-3" id="text-2-5">
<p>
An OS can divide the privileges based on the function ("role") they
have, such as backup, file system integrity check, filtration of
incoming packets.  Each user is permitted a collection of roles.  RBAC
can implement MAC.  There is a considerable amount of discrete
mathematics developed for RBAC and MAC.
</p>
</div>
</div>

<div id="outline-container-org52a381b" class="outline-3">
<h3 id="org52a381b"><span class="section-number-3">2.6</span> Source Code Review</h3>
<div class="outline-text-3" id="text-2-6">
<p>
Source code review, both by human experts and automated software tools
based on mathematical proof techniques, can reveal
vulnerabilities.  See the Secure Coding article.
</p>
</div>
</div>

<div id="outline-container-org39e500d" class="outline-3">
<h3 id="org39e500d"><span class="section-number-3">2.7</span> Check Thyself</h3>
<div class="outline-text-3" id="text-2-7">
<p>
We must always assume that there can be (many unknown) ways of
corrupting a kernel, running processes and loaded libraries.  So kernel
should include an integrity checking system which would check the
integrity of kernel, while running, using crypto algorithms.
</p>
</div>
</div>

<div id="outline-container-org9a2b619" class="outline-3">
<h3 id="org9a2b619"><span class="section-number-3">2.8</span> Mutual authentication: init v kernel</h3>
<div class="outline-text-3" id="text-2-8">
<p>
In spite of file system audits, suppose we have a rogue kernel that
was loaded through the OS loader (such as Grub).  How can we detect?
Similarly, suppose the <code>/sbin/init</code> was replaced.  The conceptual
answer is to mutually authenticate using MD5 and SHA1 sums.
</p>
</div>
</div>

<div id="outline-container-org6bcd7c5" class="outline-3">
<h3 id="org6bcd7c5"><span class="section-number-3">2.9</span> Scope of ptrace(2)</h3>
<div class="outline-text-3" id="text-2-9">
<p>
Through the <code>ptrace(2)</code> system call one process (the "tracer") may
observe and control the execution of another process (the "tracee"),
and examine and change the tracee's memory and registers.  It is
primarily used to implement breakpoint debugging and system call
tracing.  A single user is able to examine the memory and running
state of any of their own processes.  By compromising one
application process, an attacker can attach to other running processes
(a web browser e.g.) to extract credentials and continue to expand the
scope of their attack without resorting to user-assisted phishing.
Since ptrace is not used by non-developers and non-admins, system
builders should disable this debugging system on "normally" deployed
systems.
</p>

<p>
Some applications (e.g., ssh-agent) use <code>prctl(PR-SET-DUMPABLE, ...)</code> to
specifically disallow such ptrace attachment ), but many
do not. A more general solution is to only allow ptrace directly from a
parent to a child process (i.e. direct "gdb EXE" and "strace EXE" still
work), or with CAP-SYS-PTRACE (i.e. "gdb &#x2013;pid=PID", and "strace -p PID"
still work as root).
</p>
</div>
</div>


<div id="outline-container-orgaa218ab" class="outline-3">
<h3 id="orgaa218ab"><span class="section-number-3">2.10</span> Trusted OS Loader</h3>
<div class="outline-text-3" id="text-2-10">
<p>
TrustedGRUB <a href="http://projects.sirrix.com/trustedgrub">http://projects.sirrix.com/trustedgrub</a> extends the GRUB
bootloader with TCG support.  This makes it possible to provide a
secure bootstrap architecture.  The whole boot process is measured
and - by support of a Trusted Platform Module (TPM) - the system
integrity is verifyable.
</p>
</div>
</div>
</div>


<div id="outline-container-org8886275" class="outline-2">
<h2 id="org8886275"><span class="section-number-2">3</span> Security Enhancements in the Linux Kernel</h2>
<div class="outline-text-2" id="text-3">
<p>
Whereas the previous section described hardening ideas in general,
this section is a summary of security enhancements of the Linux kernel
that have occurred over the years.  Most of these are now (2013) part
of the officially released Linux kernel source code tree.
</p>

<p>
Many groups offer open source patches to Linux kernel prevent various
attacks.  Each patch has its own limitations and side effects.
Patches released in binary form should in general be not trusted.
Linux patches are source code.  These replace section(s) of code in
the kernel source code tree.  Often a patch is in response to a newly
discovered security hole.  There are proactive modifications also.
Open Wall Linux (<a href="http://www.openwall.com/Owl/">http://www.openwall.com/Owl/</a>), e.g., is a collection
of patches for non-executable stack, temporary file race condition
prevention, restricted proc file system, special handling of file
descriptors 0, 1, 2, destroy shared memory segments not in use,
enforce RLIMITNPROC on execve, and privileged IP aliases.
</p>
</div>

<div id="outline-container-org4be72ed" class="outline-3">
<h3 id="org4be72ed"><span class="section-number-3">3.1</span> POSIX capabilities</h3>
<div class="outline-text-3" id="text-3-1">
<p>
POSIX capabilities (Pcaps) can turn a setuid-root file into a file
with minimum privileges, run a daemon with uid=0 but with amost no
superuser privileges, etc.  Privileges are granted to processes
instead of users.    The table
below presents Pcaps for a few typical suid-root binaries.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">ping</td>
<td class="org-left">CAP-NET-RAW (13)</td>
</tr>

<tr>
<td class="org-left">traceroute</td>
<td class="org-left">CAP-NET-RAW (13)</td>
</tr>

<tr>
<td class="org-left">chsh</td>
<td class="org-left">CAP-CHOWN (0), CAP-DAC-READ-SEARCH (2), CAP-FSETID (4), CAP-SETUID (7)</td>
</tr>

<tr>
<td class="org-left">chfn</td>
<td class="org-left">CAP-CHOWN (0), CAP-DAC-READ-SEARCH (2), CAP-FSETID (4), CAP-SETUID (7)</td>
</tr>

<tr>
<td class="org-left">chage</td>
<td class="org-left">CAP-DAC-READ-SEARCH (2)</td>
</tr>

<tr>
<td class="org-left">passwd</td>
<td class="org-left">CAP-CHOWN (0), CAP-DAC-OVERRIDE (1), CAP-FOWNER (3)</td>
</tr>

<tr>
<td class="org-left">mount</td>
<td class="org-left">CAP-DAC-OVERRIDE (1), CAP-SYS-ADMIN (21)</td>
</tr>

<tr>
<td class="org-left">umount</td>
<td class="org-left">CAP-DAC-OVERRIDE (1), CAP-SYS-ADMIN (21)</td>
</tr>
</tbody>
</table>

<p>
Pcaps are implemented in Linux kernels since 2.6.x; <code>capsh, getpcaps,
getcap, setcap</code> are some of the tools.  E.g., to reduce the privileges
of the nomrallu suid-ed chsh, run <code>chmod u-s /usr/bin/chsh; setcap
0,2,4,7=ep /usr/bin/chsh</code>
</p>
</div>
</div>

<div id="outline-container-org3edc577" class="outline-3">
<h3 id="org3edc577"><span class="section-number-3">3.2</span> Linux Namespaces</h3>
<div class="outline-text-3" id="text-3-2">
<p>
A namespace of a process is a collection of "names" associated with
processes and pids, files, volumes, mount table, the network stack
(ports, sockets, interfaces), etc.  A single call <code>unshare(2)</code> creates a
new namespace for the current process (see also <code>man unshare</code>).
</p>

<p>
The following namespaces are available.
</p>

<ol class="org-ol">
<li><code>mount namespace</code> mounting and unmounting filesystems will not affect
rest of the system</li>

<li><code>UTS namespace</code> setting hostname, domainname will not affect rest of
the system</li>

<li><code>IPC namespace</code> process will have independent namespace for System
message queues, semaphore sets and shared memory segments</li>

<li><code>network namespace</code> process will have independent IPv4 and IPv6
stacks, IP routing tables, firewall rules, the /proc/net and
/sys/class/net directory trees, sock‐ ets etc.</li>
</ol>

<p>
As an example use of namespaces, consider routing.  The set of network
interfaces and routing tables are shared across the entire OS and all
processes.  With network namespaces, different and separate instances
of "the network" can be made.
</p>

<p>
The <code>unshare(1)</code> command 
starts a child process with the mount, UTS, IPC or network namespaces
"unshared" from its parent.   The <code>systemd</code> uses mount namespaces for the
ReadWriteDirectories, ReadOnlyDirectories or InaccessibleDirectories
unit configuration options, and for systemd-nspawn.
</p>
</div>
</div>

<div id="outline-container-org0d3f3a2" class="outline-3">
<h3 id="org0d3f3a2"><span class="section-number-3">3.3</span> Hardening the System Calls</h3>
<div class="outline-text-3" id="text-3-3">
<p>
REMUS (REference Monitor for UNIX Systems [Bernaschi et al. 2002]) is
a kernel patch which intercepts system calls without requiring changes
to syntax and semantics of existing system calls.  REMUS presents a
complete classification of the system calls according to the level of
threat.
</p>
</div>
</div>

<div id="outline-container-org37e6181" class="outline-3">
<h3 id="org37e6181"><span class="section-number-3">3.4</span> Seccomp (Secure Computing Mode)</h3>
<div class="outline-text-3" id="text-3-4">
<ol class="org-ol">
<li>Sandboxing mechanism in the kernel</li>
<li>After a process starts, a one-way transition into a state
where no system calls except <code>exit, sigreturn,
    read, write</code> and <code>close</code> are permitted.</li>
<li>Attempts to other system calls, will <code>SIGKILL</code> the process.</li>
<li>Process enters <code>seccom</code> via <code>prctl()</code> system call</li>
<li>Programs using this: OpenSSH, vsftpd, Chrome, &#x2026;</li>
</ol>
</div>
</div>

<div id="outline-container-org0ccfe5c" class="outline-3">
<h3 id="org0ccfe5c"><span class="section-number-3">3.5</span> Control Groups (cgroups)</h3>
<div class="outline-text-3" id="text-3-5">
<p>
A cgroup is a collection of processes that are bound by the same
criteria to limit, police and account the resource usage Compared to
the <code>nice</code> prefix command or <code>/etc/security/limits.conf</code>, cgroups are
more flexible.  The kernel source tree has
Documentation/cgroups/cgroups.txt
</p>
</div>
</div>



<div id="outline-container-org92f5bc7" class="outline-3">
<h3 id="org92f5bc7"><span class="section-number-3">3.6</span> Linux Security Modules (LSM)</h3>
<div class="outline-text-3" id="text-3-6">
<p>
See the section below.
</p>

<p>
The Linux Kernel Security Module (LSM) is a kernel framework that
enables many different access control models as loadable kernel
modules.  Currently (2013), the Linux kernel source tree has AppArmor,
SELinux, SMACK, TOMOYO, Yama, and Unix DAC (Discretionary Access
Controls).  LSM may become stackable in future.
</p>

<p>
AppArmor associates assigns a security profile to each program that
restricts the capabilities of that program.  It supplements the
traditional discretionary access control (DAC) model with mandatory
access control (MAC).  Ubuntu uses apparmor by default, and the
profiles are located in <code>/etc/apparmor*</code>
</p>

<p>
SELinux (Security-Enhanced Linux) is a contribution by the National
Security Agency.  It restricts the actions that programs can take.
AppArmor identifies file system objects by path name instead of inode.
This means that, for example, a file that is inaccessible may become
accessible under AppArmor when a hard link is created to it, while
SELinux would deny access through the newly created hard link.  On the
other hand, data that is inaccessible in SELinux may become accessible
when applications update the file by replacing it with a new version, a
frequently used technique, while AppArmor would continue to deny access
to the data.  In both cases, a default policy of "no access" avoids
the problem.
</p>

<p>
Smack consists of three components: a MAC LSM, a startup script that
ensures that device files have the correct Smack attributes and loads
the Smack configuration, and a set of patches to the GNU Core
Utilities package to make it aware of Smack extended file attributes.
Smack was/is used in the mobile OSs named MeeGo and Tizen.
</p>

<p>
TOMOYO is a name-based MAC LSM, as opposed to inode based security.
"Every process is created to achieve a purpose, and like an
immigration officer, TOMOYO Linux allows each process to declare
behaviours and resources needed to achieve their purpose. When
protection is enabled, TOMOYO Linux acts like an operation watchdog,
restricting each process to only the behaviours and resources allowed
by the administrator." [from TOMOYO's web site]
</p>

<p>
Yama extends DAC support with additional system-wide security
settings.  Currently available is ptrace scope restriction.  Further
information can be found in Documentation/security/Yama.txt.
</p>
</div>
</div>

<div id="outline-container-org8d2e399" class="outline-3">
<h3 id="org8d2e399"><span class="section-number-3">3.7</span> Chroot Restrictions</h3>
<div class="outline-text-3" id="text-3-7">
<p>
Every process has a current working directory that it begins with and
a root directory, which is used to resolve the absolute path names of
files.  By default, the root directory of a process is /.  Chroot system
call changes the directory that is considered the root of a
process.  All subsequent absolute path names of a file are resolved
with respect to the new root.  The process cannot access files that are
outside of the tree rooted at the new root directory, even in the
presence of hard or symbolic links.  Such a process is said to be in a
chroot jail.  Server daemons, such as anonymous FTP server, and web
server, where the processes need only access to a limited sub tree,
are run inside a chroot jail for security reasons.  Unfortunately,
weaknesses exist, and a jailed super user process can break out of
it.  Linux chroot restricts only the real (e.g., persistent storage
media) file system access of the processes in the jail.  Using
interprocess communication mechanisms such as domain sockets, shared
memory segments, and signals, a jailed process can damage the rest of
the system.
</p>

<p>
By exploiting <code>chroot, chdir, fchdir</code> system calls, an attacker with
root privileges can break chroot jail.  None of the three system calls
check to make sure that current working directory (cwd) is within the
root directory of the process.  When a process calls chroot, the root
directory of the process is changed but cwd is left unchanged.  If
process has a directory open, which is outside the root directory, it
can call fchdir to that directory and the cwd of the process changes
to that directory.  Once the cwd goes out of the root directory of the
process, the process is successful in breaking the chroot jail.
</p>
</div>
</div>

<div id="outline-container-org117fba3" class="outline-3">
<h3 id="org117fba3"><span class="section-number-3">3.8</span> Grsecurity</h3>
<div class="outline-text-3" id="text-3-8">
<p>
Grsecurity [Spender 2003] uses the least privilege principle.  Some of
the features of Grsecurity are Trusted Path Execution, Process-based
Mandatory Access Control, Access control lists, chroot restrictions,
randomizing PIDs, IP IDs, TCP initial sequence numbers, and FIFO
restrictions.
</p>

<p>
Traditionally, a "trusted path" is one where the parent directory is owned
by root and is neither group nor others writable.  A file is said to
be in the trusted path only if the directory of the file is owned by
root and it has neither group nor others writable permissions.  TPE
works based on an internal list of trusted user ids.  If a given user
tries to execute a file not in the Trusted Path, and their user id is
not in the kernels trusted list, they are denied execution privileges.
This is known as Trusted Path Execution.
</p>

<p>
The RBAC Mandatory Access Control system of grsecurity was the
inspiration for SELinux and AppArmor.  Grsecurity is "coupled" with
PaX in how its source code is distributed.
</p>
</div>
</div>

<div id="outline-container-orgc1e6b02" class="outline-3">
<h3 id="orgc1e6b02"><span class="section-number-3">3.9</span> PaX Address Space Protection</h3>
<div class="outline-text-3" id="text-3-9">
<p>
PaX invented ASLR.  PaX patches provide: Segmentation-based
implementation of non-executable pages; Mprotect restrictions prevent
new code from entering a task; Randomization of stack and mmap base;
Randomization of heap base; Randomization of executable base;
Randomization of kernel stack; Automatically emulate sigreturn
trampolines; No ELF .text relocations; No kernel modification via
/dev/mem, /dev/kmem, or /dev/port; Option to disable use of raw I/O;
Removal of addresses from <code>/proc/*/maps</code> and <code>/proc/*/stat</code>.
</p>
</div>
</div>


<div id="outline-container-orgda493eb" class="outline-3">
<h3 id="orgda493eb"><span class="section-number-3">3.10</span> Buffer Overflow Attack Prevention</h3>
<div class="outline-text-3" id="text-3-10">
<p>
There have been patches including Open Wall Linux patch, Segmented-
PAX [Team 2003], KNOX [Purczynski 2003a], RSX module [Starzetz 2003],
Paging-PAX, and Exec shield.  All these source code patches aim to
prevent stack and heap execution at kernel level by using either
segmentation logic or paging logic or both.  See the Buffer Overflow
article also.
</p>
</div>
</div>

<div id="outline-container-org70b821e" class="outline-3">
<h3 id="org70b821e"><span class="section-number-3">3.11</span> Linux Security Modules (LSM)</h3>
<div class="outline-text-3" id="text-3-11">
<ol class="org-ol">
<li>AppArmor confines individual programs to a set of listed files and
posix 1003.1e draft capabilities.</li>
<li>AppArmor: Name-based Access Controls</li>

<li><a href="http://sourceforge.net/projects/realtime-lsm/">http://sourceforge.net/projects/realtime-lsm/</a> The Realtime Linux
Security Module (LSM) selectively grants realtime permissions to
specific user groups or applications.</li>

<li>Enforcer Linux Security Module (LSM) The Enforcer is a Linux
Security Module designed to improve integrity of a computer
running Linux by ensuring no tampering of the filesystem.  It can
interact with TCPA hardware to provide higher levels of assurance
for software and sensitive data.  <a href="http://enforcer.sourceforge.net/">http://enforcer.sourceforge.net/</a></li>
</ol>
</div>
</div>

<div id="outline-container-orgeae39b8" class="outline-3">
<h3 id="orgeae39b8"><span class="section-number-3">3.12</span> Secure Linux containers</h3>
<div class="outline-text-3" id="text-3-12">
</div>
<div id="outline-container-orgdaac6df" class="outline-4">
<h4 id="orgdaac6df"><span class="section-number-4">3.12.1</span> What is a Container?</h4>
<div class="outline-text-4" id="text-3-12-1">
<ol class="org-ol">
<li>Lightweight virtual OSs running inside Linux</li>
<li>Not a virtual machine like VirtualBox or VMware</li>
<li>A container is a group of processes in a "box"
<ol class="org-ol">
<li>Inside the box, it looks like a VM.</li>
<li>Outside the box, it looks like normal processes.</li>
<li>"chroot on steroids"</li>
</ol></li>
<li>Process isolation</li>
<li>Name space isolation</li>
<li>What is a Hypervisor?</li>
<li>Example container software: LXC, Docker, OpenVZ.org</li>
</ol>
</div>
</div>

<div id="outline-container-org853814d" class="outline-4">
<h4 id="org853814d"><span class="section-number-4">3.12.2</span> LXC on Ubuntu</h4>
<div class="outline-text-4" id="text-3-12-2">
<ol class="org-ol">
<li><a href="https://help.ubuntu.com/lts/serverguide/lxc.html">https://help.ubuntu.com/lts/serverguide/lxc.html</a></li>
<li><code># apt-get install lxc</code></li>
<li>KVM is a virtual machine running on Linux kernel.
Relies on assistance from the CPU .
Uses paravirtualization to reduce overhead.</li>

<li>LXC v Xen:   Both are light weight virtual OS, not VM</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org22e79d6" class="outline-3">
<h3 id="org22e79d6"><span class="section-number-3">3.13</span> Linux Memory Forensics</h3>
<div class="outline-text-3" id="text-3-13">
<ol class="org-ol">
<li><code>% ls -l /proc/sys/vm</code></li>
<li>Keep kernel details confidential? <code>% ls -l /boot</code></li>
</ol>
<div class="org-src-container">
<pre class="src src-bash">-rw-r--r-- 1 root    root     1007311 Oct  2 19:19 abi-3.11.0-11-lowlatency
-rw-r--r-- 1 root    root      163504 Oct  2 19:19 config-3.11.0-11-lowlatency
-rw-r--r-- 1 root    root    26228945 Oct 17 23:33 initrd.img-3.11.0-11-lowlatency
-rw------- 1 root    root     3310511 Oct  2 19:19 System.map-3.11.0-11-lowlatency
-rw------- 1 root    root     5674032 Oct  2 19:19 vmlinuz-3.11.0-11-lowlatency
</pre>
</div>
</div>
</div>

<div id="outline-container-org2f9bf56" class="outline-3">
<h3 id="org2f9bf56"><span class="section-number-3">3.14</span> Intrusion Detection/ Prevention</h3>
<div class="outline-text-3" id="text-3-14">
<p>
No matter what design enhancements have been made, we should be
prepared for intrusion, and hence must have OS functionality that can
detect things.
</p>

<p>
Linux Intrusion Detection System (LIDS), is a a series of kernel
patches that enable loadable module and mount point locking.  Its
focus is on Access Control Lists.  LIDS features include enhancements
to Linux capabilities, protecting important files, protecting Raw I/O
devices, protecting important processes, and port scan detector at the
kernel level.  
</p>

<p>
Snort is an open source network intrusion prevention and detection
system (IDS/IPS) combining signature, protocol, and anomaly-based
inspection.  "Snort can perform protocol analysis and content
searching/matching. It can be used to detect a variety of attacks and
probes, such as buffer overflows, stealth port scans, CGI attacks, SMB
probes, OS fingerprinting attempts, and much more. It uses a flexible
rules language to describe traffic that it should collect or pass, as
well as a detection engine that utilizes a modular plug-in
architecture. Snort has a real-time alerting capability as well,
incorporating alerting mechanisms for syslog, a user specified file, a
UNIX socket, or WinPopup messages to Windows clients. Snort has three
primary uses: a straight packet sniffer like tcpdump, a packet logger
(useful for network traffic debugging, etc), or a full-blown network
intrusion prevention system." [from <a href="http://www.snort.org/">http://www.snort.org/</a>]
</p>

<p>
The snort can easily belong in Fortification.
</p>
</div>
</div>
</div>

<div id="outline-container-org212274a" class="outline-2">
<h2 id="org212274a"><span class="section-number-2">4</span> Kernel Security Modules</h2>
<div class="outline-text-2" id="text-4">
<ol class="org-ol">
<li>The Linux Kernel Security Module (LKSM, aka LSM) mechanism permits
new kernel extensions.</li>

<li>These extensions are not actually loadable kernel modules.
Instead, they are selectable at build-time via
CONFIG<sub>DEFAULT</sub><sub>SECURITY</sub> and can be overridden at boot-time via the
"security=&#x2026;" kernel command line argument</li>

<li>The primary users of the LSM interface are Mandatory Access Control
(MAC) extensions.</li>

<li><code>cat /sys/kernel/security/lsm</code> A list of the active security
modules in the kernel now in use.</li>

<li><p>
The following grep results are from an old build of Ubuntu standard kernel:
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #b22222;"># </span><span style="color: #b22222;">grep CONFIG_DEFAULT_SECURITY /boot/config-4.18.0-10-generic </span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">CONFIG_DEFAULT_SECURITY_SELINUX is not set</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">CONFIG_DEFAULT_SECURITY_SMACK is not set</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">CONFIG_DEFAULT_SECURITY_TOMOYO is not set</span>
<span style="color: #a0522d;">CONFIG_DEFAULT_SECURITY_APPARMOR</span>=y
<span style="color: #b22222;"># </span><span style="color: #b22222;">CONFIG_DEFAULT_SECURITY_DAC is not set</span>
<span style="color: #a0522d;">CONFIG_DEFAULT_SECURITY</span>=<span style="color: #8b2252;">"apparmor"</span>
</pre>
</div></li>

<li>The following grep results <a href="./grep-security.txt">./grep-security.txt</a> are from a recent
build <code>/boot/config-5.4.0-050400rc2-generic</code> of Ubuntu standard kernel</li>
</ol>
</div>
</div>



<div id="outline-container-orgae235aa" class="outline-2">
<h2 id="orgae235aa"><span class="section-number-2">5</span> References</h2>
<div class="outline-text-2" id="text-5">
<ol class="org-ol">
<li><a href="https://www.kernel.org/doc/html/v4.19/admin-guide/LSM/index.html">https://www.kernel.org/doc/html/v4.19/admin-guide/LSM/index.html</a>
Linux Security Module Usage 2018</li>

<li><a href="https://www.kernel.org/doc/html/v4.19/admin-guide/security-bugs.html">https://www.kernel.org/doc/html/v4.19/admin-guide/security-bugs.html</a>
Kernel Bug reporting, and Bug hunting.  2018</li>
</ol>
</div>
</div>


<div id="outline-container-org5a31292" class="outline-2">
<h2 id="org5a31292"><span class="section-number-2">6</span> End</h2>
<div class="outline-text-2" id="text-6">
</div>
</div>
</div>
<div id="postamble" class="status">
<hr size=1>Copyright &copy; 2018 <a href="http://www.wright.edu/~pmateti">www.wright.edu/~pmateti</a> &bull; 2018-10-10
</div>
</body>
</html>
